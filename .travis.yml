language: cpp
jobs:
  include:
    - name: "MacOSX Client"
      os: osx
      osx_image: xcode8
      script:
        - brew update
        - . ./lib.sh
        - install_minetest_osx_builddeps
        - mkdir -p /tmp/WORKSPACE
        - pushd /tmp/WORKSPACE
        - get_minetest
        - build_minetest_client_osx
        - mkdir -p /tmp/WORKSPACE/DEPLOY/client/macosx
        - cp -rv ./minetest/*.zip /tmp/WORKSPACE/DEPLOY/client/macosx/minetest.zip
        - popd
    - name: "GNU/Linux AMD64 Client"
      os: linux
      dist: xenial
      script:
        - sudo apt update
        - . ./lib.sh
        - install_minetest_debian_builddeps
        - mkdir -p /tmp/WORKSPACE
        - pushd /tmp/WORKSPACE
        - get_minetest
        - build_minetest_client_gnulinux_amd64
        - mkdir -p /tmp/WORKSPACE/DEPLOY/client/gnulinux/amd64
        - cp ./minetest/minetest.AppImage /tmp/WORKSPACE/DEPLOY/client/gnulinux/amd64
        - popd
    - name: "Windows AMD64 Client"
      os: linux
      dist: xenial
      script:
        - sudo apt update
        - . ./lib.sh
        - install_minetest_debian_builddeps
        - mkdir -p /tmp/WORKSPACE
        - pushd /tmp/WORKSPACE
        - CONFIG_WIN_ARCH=x86_64
        - install_minetest_mingw_builddeps__and__build__ubuntu1604
        - mkdir -p /tmp/WORKSPACE/DEPLOY/client/windows/amd64
        - cp ./minetest/minetest.zip /tmp/WORKSPACE/DEPLOY/client/windows/amd64
        - popd
    - name: "Windows i686 Client"
      os: linux
      dist: xenial
      script:
        - sudo apt update
        - . ./lib.sh
        - install_minetest_debian_builddeps
        - mkdir -p /tmp/WORKSPACE
        - pushd /tmp/WORKSPACE
        - CONFIG_WIN_ARCH=i686
        - install_minetest_mingw_builddeps__and__build__ubuntu1604
        - mkdir -p /tmp/WORKSPACE/DEPLOY/client/windows/i686
        - cp ./minetest/minetest.zip /tmp/WORKSPACE/DEPLOY/client/windows/i686
        - popd
    - name: "GNU/Linux AMD64 Server"
      os: linux
      dist: xenial
      script:
        - sudo apt update
        - . ./lib.sh
        - install_minetest_debian_builddeps
        - mkdir -p /tmp/WORKSPACE
        - pushd /tmp/WORKSPACE
        - get_minetest
        - build_minetest_server_gnulinux_amd64
        - mkdir -p /tmp/WORKSPACE/DEPLOY/server/gnulinux/amd64
        - cp ./minetest/minetestserver.AppImage /tmp/WORKSPACE/DEPLOY/server/gnulinux/amd64
        - popd

after_success:
  - |
    if [ -n "${GITHUB_OAUTH_TOKEN}" ] && [ -d /tmp/WORKSPACE/DEPLOY ] ;then
      git config --global user.email tsao-chi@the-lingo.org
      git config --global user.name 'ㄗㄠˋ ㄑㄧˊ'
      git clone --depth 1 https://${GITHUB_OAUTH_TOKEN}@github.com/The-Unstable-World/binary.git /tmp/WORKSPACE/deploy_repo
      cd /tmp/WORKSPACE/deploy_repo
      cp -rv /tmp/WORKSPACE/DEPLOY/* ./
      git add .
      git commit -m 'deploy' || true
      git push --force
    fi
