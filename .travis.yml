language: cpp
matrix:
  include:
    - os: osx
      osx_image: xcode8
      script:
        - brew update
        - . ./lib.sh
        - install_minetest_osx_builddeps
        - mkdir -p /tmp/WORKSPACE
        - pushd /tmp/WORKSPACE
        - get_minetest
        - build_minetest_client_osx
        - mkdir -p /tmp/WORKSPACE/DEPLOY/client/macosx
        - cp -rv $(echo ./minetest/*.zip | awk '{print $1}') /tmp/WORKSPACE/DEPLOY/client/macosx/minetest.zip
        - popd
    - os: linux
      dist: xenial
      script:
        - sudo apt update
        - . ./lib.sh
        - install_minetest_debian_builddeps
        - mkdir -p /tmp/WORKSPACE
        - pushd /tmp/WORKSPACE
        - get_minetest
        - build_minetest_client_debian
        - mkdir -p /tmp/WORKSPACE/DEPLOY/client/gnulinux/amd64
        - cp ./minetest/minetest.AppImage /tmp/WORKSPACE/DEPLOY/client/gnulinux/amd64
        - popd

after_success:
  - |
    if [ -n "${GITHUB_OAUTH_TOKEN}" ] && [ -d /tmp/WORKSPACE/DEPLOY ] ;then
      git config --global user.email tsao-chi@the-lingo.org
      git config --global user.name 'ㄗㄠˋ ㄑㄧˊ'
      git clone --depth 1 https://${GITHUB_OAUTH_TOKEN}@github.com/The-Unstable-World/binary.git /tmp/WORKSPACE/deploy_repo
      cd /tmp/WORKSPACE/deploy_repo
      cp -rv /tmp/WORKSPACE/DEPLOY/* ./
      git add .
      git commit -m 'deploy' || true
      git push --force
    fi
